#!/bin/bash

# Kubernetes Tools - Copyright (C) 2017 Shawn Wang
# https://github.com/shawnxlw/kubernetes-tools
#
# You may use, distribute or modify this software under the terms of the MIT license.

if [[ -f __common ]]; then
  source __common
fi

get_logs() {
  pod=${1}
  option=${2}

  PS3="Please select a container:"
  containers=($(/bin/sh -c "kubectl get pod ${pod} -o jsonpath='{.spec.containers[*].name}'"))

  # if there is only one container, set it as selected container
  if [[ ${#containers[@]} -eq 1 ]] ; then
    selected_container=${containers}
  else
    # if there are more than one container, prompt select
    select container in "${containers[@]}"
    do
      selected_container=${container}
      break
    done
  fi

  echo -e "\nGetting you logs of ${selected_container}...\n"
  # get logs of the selected pod

  if [[ "${option}" == "-f" ]] || [[ "${option}" == "--follow" ]]; then
    # Specify if the logs should be streamed.
    follow="--follow"
  fi

  kubectl logs ${pod} -c ${selected_container} ${follow}
  exit 0

}

# show help
show_help() {
  echo -e "${__title}
- Get logs of a selected container: ${__style_underlined}klogs [pod_name] [options]${__style_end}

Options:
  -f | --follow: Specify if the logs should be streamed.
  -n | --namespace: Specify currente namespace."
}

# parse arguments
while [ "${1}" != "" ]; do
  case ${1} in
    -n | --namespace ) shift
      get_logs "${1}"
      ;;
    -h | --help ) shift
      show_help
      exit 0
      ;;
    * ) get_logs "${1}" "${2}"
  esac
  shift
done

# show help if no arguments
if [ $# -eq 0 ]; then show_help; fi
